# Hooks & Filters

## Lama initialised on ajax request

When lama is initialised after the ajax request the following actions are triggered:

```php
do_action( 'lama_init' );

// FORM NAME is the name passed to the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template)
do_action( 'lama__[FORM NAME]' );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

### Temp file

To avoid exposing the query parameters inside the HTML generated, lama stores the data needed to properly run the WP_Query when performing ajax calls inside a temporary file.
This solution should work without problem in any environment and hosting, but in case something goes wrong this filter will be executed:

```php
do_action( 'lama_temp_failed' );
```

An error message is also printed in the debug log.

## Using a custom single item template

By default the load more code is looking for the template:

`template-parts/[POST-TYPE]-single-item.php`

and, if no items are found:

`template-parts/[POST-TYPE]-single-item-none.php`

This values can be respectively customised with the following filter:

```php
$template = apply_filters( 'lama_template__[FORM NAME]', 'template-parts/' . $post_type . '-single-item.php', $post_type, $args );
```

and

```php
$template = apply_filters( 'lama_template__[FORM NAME]_none', 'template-parts/' . $post_type . '-single-item-none.php', $post_type, $args );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

### Example

```php
/**
 * The template to use is "template-parts/new-file-to-use.php"
 *
 * NOTE: "Test" is the form name we passed to Lama::start( 'test' )...
 */
add_filter( 'lama_template__test', function( $template_name, $post_type, $args ) {
    return 'whatever/new-file-to-use';
}, 10, 3 );
```

#### Include the custom template manually

By default, LAMA is looking for the template name returned by the `'lama_template__[FORM NAME]'` filter and does include
it using the (`get_template_part`)[https://developer.wordpress.org/reference/functions/get_template_part/] function.
If you need to use a custom function to include the template part, or do you want to skip the inclusion of a certain item,
you have to return `null` within the custom filter.

```php
/**
 * In this example we're including our template using the function include & locate_template.
 *
 * NOTE: "Test" is the form name we passed to Lama::start( 'test' )...
 */
add_filter( 'lama_template__test', function( $template_name, $post_type, $args ) {
  include( locate_template( $template_name ) );

  return null; // This tells lama to do not load the template!
}, 10, 3 );
```

```php
/**
 * We can also use some logic to do not display a post
 *
 * NOTE: "Test" is the form name we passed to Lama::start( 'test' )...
 */
add_filter( 'lama_template__test', function( $template_name, $post_type, $args ) {
  if ( get_the_ID() === 1 ) {
    return null;  // We don't want the post with ID 1 to be ever displayed!
  }

  return $template_name;
}, 10, 3 );
```

## WP_Query parameters

LAMA by default tries to handle all the filters present in the URL. So, if the filter starts with the key `filter-` LAMA checks if the remaining part of the name matches the name of any registered taxonomy, if so automatically applies the filter for you.
Also, if the filter starts with the key `meta-` instead, the `meta_query` will be automatically generated by LAMA.

LAMA also automatically recognise the following "special" key:

| key    | description                                                        |
| ------ | ------------------------------------------------------------------ |
| sort   | This will set the option "order" for the WP_Query                  |
| sortby | This will set the option "orderby" prefixed by the string 'post\_' |

On top of that LAMA offers this 2 filters: `lama_args` and `lama_args__[FORM NAME]` to allowing you customise the parameters passed by LAMA to the WP_Query.

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

### Usage

**`lama_args`**: this filter is always executed:

for more information about those 2 points, please have a look to the section: [Restore the filters on page refresh](/docs/UTILITY.html#restore-the-filters-on-page-refresh).

```php
// This filter allows you to customise all the requests
add_filter( 'lama_args', function( array $args, array $params, array $lama_params ) { ... }, 10, 3 );
```

- `$args` _(array)_ the arguments to be passed to the WP_Query
- `$params` _(array)_ the arguments got from the AJAX request
- `$lama_params` _(array)_ the internal parameters stored by LAMA like: page_id, base_url, pagination, etc.

**`lama_args__[FORM_NAME]`** is triggered only

- passing `'lama' => [FORM_NAME]` parameter to the [custom WP_Query](/docs/USAGE.html#use-lama-with-custom-wp-query)
- when the `?query=[FORM_NAME]` parameter is present on the page load
- when performing the ajax request

```php
// This filter allows you to customise only the requests coming from a specific form name.
add_filter( 'lama_args__[FORM NAME]', function( array $args, array $params, array $lama_params ) { ... }, 10, 3 );
```

- `$args` _(array)_ the arguments to be passed to the WP_Query
- `$params` _(array)_ the arguments got from the AJAX request
- `$lama_params` _(array)_ the internal parameters stored by LAMA like: page_id, base_url, pagination, etc.

_Note:_ when working with the main query LAMA doesn't know if has to run those filter, unless the parameter `?query=[...]` is present in the URL. But another way to make LAMA triggering the filter is by manually passing `'lama' => [FORM_NAME]` to the main query:

```php
add_action( 'pre_get_posts', 'add_lama_parameter_to_main_query' );

/**
 * Adding 'lama' => 'test' will allow LAMA to trigger the filter `lama_args__test`
 */
function add_lama_parameter_to_main_query( $query ) {
  if ( is_archive( 'test' ) ) {
    $query->set( 'lama', 'test' );
  }
}
```

This will allow us to use the same filter for the main query and the one generated by LAMA.

#### Why is this needed?

Because the main query is executed before any template is loaded, so by the time we call `LAMA::start` is too late to do any changes to the main query.

### Example

```php
/**
 * This filter is called by LAMA with the argument array to be passed to WP_Query.
 *
 * @param array $args   array of arguments to pass to WP_Query.
 * @param array $params all the form input fields.
 */
function test_args( $args, $params ) {
  $args['meta_key'] = 'META_KEY';
  $args['meta_value'] = 'META_VALUE';

  return $args;
} );

add_filter( 'lama_args__testname', 'test_args', 10, 2 );
```

**NOTE** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

**NOTE**: we can prevent LAMA from running the WP_Query function if our filter does not return an array.
For more information about please check [Use LAMA with a custom Query](/docs/UTILITY.PHP#use-lama-with-a-custom-query)

## Before the loop

The `lama_before_loop__[FORM NAME]` filter allows adding 3rd party HTML before the LAMA's loop that output the single items.

### Usage

```php
do_action( 'lama_before_loop__[FORM NAME]', $posts, $args, $params );
```

### Example

```php
/**
 * This function is invoked before LAMA's loop
 *
 * @param WP_Query $posts the WP_Query.
 * @param array    $args the arguments passed to WP_Query.
 * @param array    $params the form fields.
 */
function test_before_loop( $posts, $args, $params ) {

}

// testname is the name we passed to the function Lama::start
do_action( 'lama_before_loop__testname', 'test_before_loop', 10, 3 );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

## After the loop

The `lama_after_loop__[FORM NAME]` filter allows adding 3rd party HTML after the LAMA's loop that output the single items.

### Usage

```php
do_action( 'lama_after_loop__[FORM NAME]', $posts, $args, $params );
```

### Example

```php
/**
 * This function is invoked after LAMA's loop
 *
 * @param WP_Query $posts the WP_Query.
 * @param array    $args the arguments passed to WP_Query.
 * @param array    $params the form fields.
 */
function test_after_loop( $posts, $args ) {

}

do_action( 'lama_after_loop__testname', 'test_after_loop', 10, 3 );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.

## Hidden fields

Hidden &lt;input&gt; fields are used by LAMA to store all parameters passed to the WP_Query and used them when loading the new results via Ajax.
The class stores informations such as: `post_type`, `order`, `meta` or `tax` query, etc.

Is possible alter the information stored in those fields with the following filter:

```php
/**
 * @param string $field_value the "value" attribute to pass to the hidden input
 * @param string $field_name the hidden input "name" value attribute.
 */
apply_filters( 'lama_hidden_field', $field_value, $field_name );

// To target a specific form:
apply_filters( 'lama_hidden_field__[FORM_NAME]', $field_value, $field_name );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [Lama::start](/docs/USAGE.html#use-the-class-in-your-template) function.
**NOTE**: To don't generate a hidden input for a specific field name, return an empty value using one of the above filters.

## Pagination

LAMA has built-in functionality for the pagination, if specifing `true` when [closing the container](/lama/USAGE.html#the-container).
When using the buil-in pagination, LAMA will take care to showing it, if needed, when performing DYNAMIC filtering.

The default template uses the [WP paginate_links](https://codex.wordpress.org/Function_Reference/paginate_links) function, and LAMA allows you to customise the arguments sent to this function with the following filters:

```php
$args = apply_filters( 'lama_pagination_args', $args, $show_ends, $params );

// To target a specific form
$args = apply_filters( 'lama_pagination_args__[FORM_NAME]', $args, $show_ends, $params );
```

The default template used for the pagination is saved in `templates/pagination.php`, but LAMA allows you to use your own by using one of following filter:

```php
/**
 * @param string   $lama_template the default lama pagination template
 * @param WP_Query $query         the query that needs the pagination
 */
$lama_template = apply_filters( 'lama_pagination_template', $lama_template, $query );

// To target a specific form
$lama_template = apply_filters( 'lama_pagination_template__[FORM_NAME]', $lama_template, $query );
```

**NOTE**: if you need to execute your code for the pagination, return `null` when using one of the above filters.

## JavaScript

the `lamaStart` and `lamaDone` events are triggered respectively before the ajax call has started and after it has been completed and all the items retrieved.

### Example

```js
/**
 * lamaStart is triggered before doing the ajax call
 *
 * @param Javascript Event event the JS event.
 * @param "jQuery Element" $form the LAMA form used to load the more/new data.
 * @param "jQuery Element" $container the container where the data has been added.
 */
$('body').on('lamaStart', (event, $form, $container) => {
  console.info({ $form });
});

/**
 * lamaDone is triggered after the data has been added to the DOM.
 *
 * @param Javascript Event event the JS event.
 * @param "jQuery Element" $container the container where the data has been added.
 * @param "jQuery Element" $items the elements that have been added.
 */
$('body').on('lamaDone', (event, $container, $items) => {
  console.info({ $items });
});
```
